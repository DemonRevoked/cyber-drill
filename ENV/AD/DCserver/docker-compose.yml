version: '3.8'

services:
  dc1:
    container_name: ${DC_NAME:-dc1}  # Fallback if unset, but use .env to avoid
    hostname: ${DC_NAME:-dc1}
    build:
      context: ./dockerfile
      target: dc
    restart: unless-stopped
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./config-dc1:/etc/samba/config
      - ./data-dc1:/var/lib/samba
    environment:
      - DOMAIN_FQDN=${DOMAIN_FQDN}
      - DOMAIN_DN=${DOMAIN_DN}
      - DNSFORWARDER=${MAIN_DNS_IP}
      - DC_IP=${DC_IP}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
    dns_search:
      - ${DOMAIN_FQDN}
    dns:
      - ${DC_IP}
      - ${MAIN_DNS_IP}
    extra_hosts:
      - "${DC_NAME}.${DOMAIN_FQDN}:${DC_IP}"
    privileged: true  # Required for Samba DC with vfs_acl_xattr module
    networks:
      sambanet:
        ipv4_address: ${DC_IP}
    cap_add:
      - NET_ADMIN
      - SYS_NICE
      - SYS_RESOURCE
      - SYS_TIME

  fs1:
    container_name: ${FS_NAME:-fs1}
    hostname: ${FS_NAME:-fs1}
    build:
      context: ./dockerfile
      target: fs
    restart: unless-stopped
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./config-fs1/kerberos/krb5.conf:/etc/krb5.conf
      - ./config-fs1/samba:/etc/samba/config
      - ./data-fs1:/var/lib/samba
      - ./shares-fs1:/srv/samba
    environment:
      - DOMAIN_FQDN=${DOMAIN_FQDN}
      - DOMAIN_DN=${DOMAIN_DN}
      - FS_NAME=${FS_NAME}
      - FS_IP=${FS_IP}
      - DC_IP=${DC_IP}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
    dns_search:
      - ${DOMAIN_FQDN}
    dns:
      - ${DC_IP}
      - ${MAIN_DNS_IP}
    extra_hosts:
      - "${FS_NAME}.${DOMAIN_FQDN}:${FS_IP}"
      - "${DC_NAME}.${DOMAIN_FQDN}:${DC_IP}"
    privileged: true  # Required for Samba member server ACLs
    networks:
      sambanet:
        ipv4_address: ${FS_IP}
    depends_on:
      - dc1
    cap_add:
      - NET_ADMIN
      - SYS_NICE
      - SYS_RESOURCE
      - SYS_TIME

  phpldapadmin:
    image: osixia/phpldapadmin:0.9.0
    container_name: phpldapadmin
    restart: unless-stopped
    ports:
      - "0.0.0.0:6443:443"
    environment:
      - PHPLDAPADMIN_LDAP_HOSTS=ldaps://${DC_NAME}.${DOMAIN_FQDN}:636
      - PHPLDAPADMIN_LDAP_CLIENT_TLS=true
      - PHPLDAPADMIN_LDAP_CLIENT_TLS_REQCERT=never
      - PHPLDAPADMIN_TRUST_PROXY_SSL=true
      - PHPLDAPADMIN_HTTPS=true
    dns:
      - ${DC_IP}
      - ${MAIN_DNS_IP}
    extra_hosts:
      - "${DC_NAME}.${DOMAIN_FQDN}:${DC_IP}"
    networks:
      default:
      sambanet:
        ipv4_address: ${LDAPADMIN_IP}

networks:
  sambanet:
    driver: macvlan
    driver_opts:
      parent: ${HOST_INTERFACE}
    ipam:
      config:
        - subnet: "${SUBNET}"  # Must be CIDR like 192.168.1.0/24
          gateway: "${GATEWAY}"
          ip_range: "${CONTAINER_IP_RANGE}"  # CIDR subset of SUBNET
